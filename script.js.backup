// Tab Switching Function
function switchTab(event, lessonId) {
    // Hide all tab contents
    const tabContents = document.getElementsByClassName('tab-content');
    for (let i = 0; i < tabContents.length; i++) {
        tabContents[i].classList.remove('active');
    }
    
    // Remove active class from all buttons
    const tabButtons = document.getElementsByClassName('tab-button');
    for (let i = 0; i < tabButtons.length; i++) {
        tabButtons[i].classList.remove('active');
    }
    
    // Show selected tab content
    document.getElementById(lessonId).classList.add('active');
    
    // Add active class to clicked button
    event.currentTarget.classList.add('active');
}

// Background Music Control
function toggleMusic() {
    const music = document.getElementById('bgMusic');
    const toggle = document.getElementById('bgMusicToggle');
    const status = document.getElementById('musicStatus');
    
    if (toggle.checked) {
        music.play().catch(e => console.log('Music play failed:', e));
        status.textContent = 'Bật';
        localStorage.setItem('musicEnabled', 'true');
    } else {
        music.pause();
        status.textContent = 'Tắt';
        localStorage.setItem('musicEnabled', 'false');
    }
}

// Dark Mode Control
function toggleDarkMode() {
    const toggle = document.getElementById('darkModeToggle');
    const status = document.getElementById('darkModeStatus');
    
    if (toggle.checked) {
        document.body.classList.add('dark-mode');
        status.textContent = 'Bật';
        localStorage.setItem('darkMode', 'true');
    } else {
        document.body.classList.remove('dark-mode');
        status.textContent = 'Tắt';
        localStorage.setItem('darkMode', 'false');
    }
}

// AI Reading Generator with Gemini API
const GEMINI_API_KEY = 'AIzaSyBgnR2T8yRS0Gf4bfiCegVliUn9b-Tk5q0';

// All available kanji from lessons 8-11
const ALL_KANJI = ['家', '族', '父', '母', '兄', '弟', '姉', '妹', '犬', '高', '短', '長', '好', '歌', '音', '楽', '車', '映', '画', '旅', '海', '外', '駅', '上', '下', '地', '図', '館', '右', '左', '道', '起', '歩', '乗', '始', '終', '勉', '強', '朝', '昼', '夜'];

// Random topics for variety
const TOPICS = [
    '家族について',
    '週末の過ごし方',
    '趣味について', 
    '毎日の生活',
    '旅行の思い出',
    '好きなこと',
    '学校生活',
    '友達と遊ぶ'
];

function getRandomKanji() {
    // Shuffle and pick 5-7 random kanji
    const shuffled = [...ALL_KANJI].sort(() => 0.5 - Math.random());
    const count = Math.floor(Math.random() * 3) + 5; // 5-7
    return shuffled.slice(0, count);
}

function getRandomTopic() {
    return TOPICS[Math.floor(Math.random() * TOPICS.length)];
}

async function generateReading() {
    const btn = document.getElementById('generateBtn');
    const btnText = document.getElementById('btnText');
    const loadingSpinner = document.getElementById('loadingSpinner');
    const readingResult = document.getElementById('readingResult');
    const readingContent = document.getElementById('readingContent');

    // Disable button and show loading
    btn.disabled = true;
    btnText.textContent = '⏳ Đang tạo...';
    loadingSpinner.style.display = 'block';
    readingResult.style.display = 'none';

    // Get random kanji and topic
    const selectedKanji = getRandomKanji();
    const topic = getRandomTopic();
    
    const prompt = `Hãy tạo một bài đọc tiếng Nhật về chủ đề: ${topic}

YÊU CẦU QUAN TRỌNG:
1. Viết thành 1 ĐOẠN VĂN liên tục 12-15 câu (không xuống dòng giữa các câu)
2. CHỈ sử dụng 5-7 CHỮ KANJI từ list sau (không được dùng chữ nào khác): ${selectedKanji.join(', ')}
3. Tất cả Kanji PHẢI có furigana format: 家[いえ]
4. TUYỆT ĐỐI KHÔNG dùng Kanji khác ngoài list trên
5. Sử dụng lại các Kanji nhiều lần trong bài để làm dài bài đọc
6. Format:

私[わたし]の家[いえ]族[ぞく]は四[よ]人[にん]です。父[ちち]と母[はは]と兄[あに]がいます。兄[あに]は音[おん]楽[がく]が好[す]きです。週[しゅう]末[まつ]はよく家[か]族[ぞく]で映[えい]画[が]を見[み]ます。夏[なつ]に海[うみ]へ旅[りょ]行[こう]しました。

Sau đó xuống 2 dòng và viết dịch tiếng Việt:

Gia đình tôi có bốn người. Có bố, mẹ và anh trai. Anh trai thích âm nhạc. Cuối tuần thường cùng gia đình xem phim. Mùa hè đã đi du lịch biển.

LƯU Ý:
- KHÔNG xuống dòng giữa các câu tiếng Nhật
- CHỈ dùng Kanji trong list trên
- Câu văn đơn giản, ngắn gọn`;

    try {
        // Use v1beta API endpoint with gemini-2.0-flash model
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent`;
        
        const response = await fetch(apiUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-goog-api-key': GEMINI_API_KEY
            },
            body: JSON.stringify({
                contents: [{
                    parts: [{
                        text: prompt
                    }]
                }],
                generationConfig: {
                    temperature: 0.9,
                    maxOutputTokens: 1024
                }
            })
        });

        const data = await response.json();
        
        if (!response.ok) {
            throw new Error(data.error?.message || `API Error: ${response.status}`);
        }

        if (!data.candidates || !data.candidates[0] || !data.candidates[0].content) {
            throw new Error('Invalid response from API');
        }

        const generatedText = data.candidates[0].content.parts[0].text;

        // Format the reading content
        const formattedContent = formatReadingContent(generatedText);
        readingContent.innerHTML = formattedContent;

        // Show result
        loadingSpinner.style.display = 'none';
        readingResult.style.display = 'block';
        btnText.textContent = '🎯 START - Tạo Bài Đọc Mới';
        btn.disabled = false;

    } catch (error) {
        console.error('Error:', error);
        loadingSpinner.style.display = 'none';
        readingContent.innerHTML = `
            <div class="note" style="background: #ff6b6b; color: white; border: 6px solid #000;">
                <div class="note-title">❌ Lỗi:</div>
                <p>Không thể tạo bài đọc. Vui lòng thử lại!</p>
                <p style="font-size: 0.8em; margin-top: 10px;">Chi tiết: ${error.message}</p>
                <p style="font-size: 0.7em; margin-top: 10px;">Lưu ý: Cần kết nối internet và API key hợp lệ</p>
            </div>
        `;
        readingResult.style.display = 'block';
        btnText.textContent = '🎯 START - Tạo Bài Đọc';
        btn.disabled = false;
    }
}

let romajiVisible = false;

function toggleRomaji() {
    romajiVisible = !romajiVisible;
    const romajiBtnText = document.getElementById('romajiBtnText');
    const romajiElements = document.querySelectorAll('.romaji-text');
    const textWithRuby = document.querySelectorAll('.japanese-text-with-ruby');
    const textNoRuby = document.querySelectorAll('.japanese-text-no-ruby');
    
    if (romajiVisible) {
        romajiBtnText.textContent = '🙈 Ẩn Furigana & Romaji';
        romajiElements.forEach(el => el.style.display = 'block');
        textWithRuby.forEach(el => el.style.display = 'block');
        textNoRuby.forEach(el => el.style.display = 'none');
    } else {
        romajiBtnText.textContent = '👁️ Hiện Furigana & Romaji';
        romajiElements.forEach(el => el.style.display = 'none');
        textWithRuby.forEach(el => el.style.display = 'none');
        textNoRuby.forEach(el => el.style.display = 'block');
    }
}

function formatReadingContent(text) {
    // Split by double newline to separate Japanese paragraph from Vietnamese translation
    const parts = text.split('\n\n').filter(part => part.trim());
    let html = '';
    
    for (let part of parts) {
        const trimmedPart = part.trim();
        if (!trimmedPart) continue;

        // Check if it's Japanese text (contains hiragana/katakana/kanji)
        if (/[\u3040-\u309F\u30A0-\u30FF\u4E00-\u9FAF]/.test(trimmedPart)) {
            // Create two versions: with and without furigana
            let withFurigana = trimmedPart.replace(/([一-龯々]+)\[([ぁ-んァ-ン]+)\]/g, '<ruby>$1<rt>$2</rt></ruby>');
            let withoutFurigana = trimmedPart.replace(/([一-龯々]+)\[([ぁ-んァ-ン]+)\]/g, '$1');
            
            html += `<div class="example" style="margin-bottom: 25px;">
                <div class="japanese-text-no-ruby" style="font-size: 20px; line-height: 2.2; margin-bottom: 10px; text-align: justify;">${withoutFurigana}</div>
                <div class="japanese-text-with-ruby" style="display: none; font-size: 20px; line-height: 2.8; margin-bottom: 10px; text-align: justify;">${withFurigana}</div>
                <div class="romaji-text" style="display: none; color: #9966ff; font-size: 14px; margin-bottom: 10px; font-style: italic; line-height: 1.8; word-wrap: break-word; overflow-wrap: break-word;">${convertToRomaji(trimmedPart)}</div>`;
        } else if (trimmedPart.length > 0 && !trimmedPart.startsWith('#') && !trimmedPart.startsWith('**')) {
            // Vietnamese translation
            html += `<div class="meaning" style="color: #555; font-size: 15px; line-height: 1.8; text-align: justify; padding: 15px; background: rgba(153, 102, 255, 0.1); border-radius: 8px;">${trimmedPart}</div></div>`;
        }
    }

    return html || '<div class="note"><p>Không thể format bài đọc. Vui lòng thử lại!</p></div>';
}

function convertToRomaji(text) {
    // Particles that should be separated
    const particles = ['は', 'が', 'を', 'に', 'へ', 'と', 'の', 'で', 'や', 'も', 'か', 'から', 'まで', 'より'];
    
    // Hiragana to romaji map
    const hiraganaMap = {
        'あ': 'a', 'い': 'i', 'う': 'u', 'え': 'e', 'お': 'o',
        'か': 'ka', 'き': 'ki', 'く': 'ku', 'け': 'ke', 'こ': 'ko',
        'さ': 'sa', 'し': 'shi', 'す': 'su', 'せ': 'se', 'そ': 'so',
        'た': 'ta', 'ち': 'chi', 'つ': 'tsu', 'て': 'te', 'と': 'to',
        'な': 'na', 'に': 'ni', 'ぬ': 'nu', 'ね': 'ne', 'の': 'no',
        'は': 'ha', 'ひ': 'hi', 'ふ': 'fu', 'へ': 'he', 'ほ': 'ho',
        'ま': 'ma', 'み': 'mi', 'む': 'mu', 'め': 'me', 'も': 'mo',
        'や': 'ya', 'ゆ': 'yu', 'よ': 'yo',
        'ら': 'ra', 'り': 'ri', 'る': 'ru', 'れ': 're', 'ろ': 'ro',
        'わ': 'wa', 'を': 'wo', 'ん': 'n',
        'が': 'ga', 'ぎ': 'gi', 'ぐ': 'gu', 'げ': 'ge', 'ご': 'go',
        'ざ': 'za', 'じ': 'ji', 'ず': 'zu', 'ぜ': 'ze', 'ぞ': 'zo',
        'だ': 'da', 'ぢ': 'ji', 'づ': 'zu', 'で': 'de', 'ど': 'do',
        'ば': 'ba', 'び': 'bi', 'ぶ': 'bu', 'べ': 'be', 'ぼ': 'bo',
        'ぱ': 'pa', 'ぴ': 'pi', 'ぷ': 'pu', 'ぺ': 'pe', 'ぽ': 'po',
        'きゃ': 'kya', 'きゅ': 'kyu', 'きょ': 'kyo',
        'しゃ': 'sha', 'しゅ': 'shu', 'しょ': 'sho',
        'ちゃ': 'cha', 'ちゅ': 'chu', 'ちょ': 'cho',
        'にゃ': 'nya', 'にゅ': 'nyu', 'にょ': 'nyo',
        'ひゃ': 'hya', 'ひゅ': 'hyu', 'ひょ': 'hyo',
        'みゃ': 'mya', 'みゅ': 'myu', 'みょ': 'myo',
        'りゃ': 'rya', 'りゅ': 'ryu', 'りょ': 'ryo',
        'ぎゃ': 'gya', 'ぎゅ': 'gyu', 'ぎょ': 'gyo',
        'じゃ': 'ja', 'じゅ': 'ju', 'じょ': 'jo',
        'びゃ': 'bya', 'びゅ': 'byu', 'びょ': 'byo',
        'ぴゃ': 'pya', 'ぴゅ': 'pyu', 'ぴょ': 'pyo',
        'っ': '',
        'ー': '-'
    };
    
    // Extract furigana from brackets and add spaces around kanji
    let cleanText = text.replace(/([一-龯々]+)\[([ぁ-んァ-ン]+)\]/g, ' $2 ');
    
    // Add space after punctuation
    cleanText = cleanText.replace(/[。、]/g, ' ');
    
    let result = '';
    let i = 0;
    let currentWord = '';
    
    while (i < cleanText.length) {
        const char = cleanText[i];
        
        // Handle spaces
        if (char === ' ') {
            if (currentWord) {
                result += currentWord + ' ';
                currentWord = '';
            }
            i++;
            continue;
        }
        
        let found = false;
        
        // Try 2-character combinations first (for ゃ, ゅ, ょ)
        if (i < cleanText.length - 1) {
            const twoChar = cleanText.substring(i, i + 2);
            if (hiraganaMap[twoChar]) {
                currentWord += hiraganaMap[twoChar];
                i += 2;
                found = true;
            }
        }
        
        // Try single character
        if (!found) {
            if (hiraganaMap[char]) {
                const romaji = hiraganaMap[char];
                
                // Check if this is a particle
                if (particles.includes(char) && currentWord) {
                    // Add space before particle
                    result += currentWord + ' ';
                    currentWord = '';
                    
                    // Special case: は as particle = wa
                    if (char === 'は') {
                        currentWord = 'wa';
                    } else if (char === 'へ') {
                        currentWord = 'e';
                    } else {
                        currentWord = romaji;
                    }
                } else {
                    currentWord += romaji;
                }
            } else {
                currentWord += char;
            }
            i++;
        }
    }
    
    // Add remaining word
    if (currentWord) {
        result += currentWord;
    }
    
    // Clean up multiple spaces
    return result.replace(/\s+/g, ' ').trim();
}

// Load saved settings on page load
window.addEventListener('DOMContentLoaded', function() {
    // Load music setting
    const musicEnabled = localStorage.getItem('musicEnabled') === 'true';
    const musicToggle = document.getElementById('bgMusicToggle');
    const musicStatus = document.getElementById('musicStatus');
    if (musicEnabled && musicToggle) {
        musicToggle.checked = true;
        musicStatus.textContent = 'Bật';
    }

    // Load dark mode setting
    const darkModeEnabled = localStorage.getItem('darkMode') === 'true';
    const darkModeToggle = document.getElementById('darkModeToggle');
    const darkModeStatus = document.getElementById('darkModeStatus');
    if (darkModeEnabled) {
        document.body.classList.add('dark-mode');
        if (darkModeToggle) {
            darkModeToggle.checked = true;
            darkModeStatus.textContent = 'Bật';
        }
    }
});

// Kanji Test System
const KANJI_DATA = {
    8: [
        {kanji: '家', meaning: 'nhà', reading: 'いえ・うち'},
        {kanji: '族', meaning: 'tộc, gia đình', reading: 'ゾク'},
        {kanji: '父', meaning: 'bố', reading: 'ちち'},
        {kanji: '母', meaning: 'mẹ', reading: 'はは'},
        {kanji: '兄', meaning: 'anh trai', reading: 'あに'},
        {kanji: '弟', meaning: 'em trai', reading: 'おとうと'},
        {kanji: '姉', meaning: 'chị gái', reading: 'あね'},
        {kanji: '妹', meaning: 'em gái', reading: 'いもうと'},
        {kanji: '犬', meaning: 'chó', reading: 'いぬ'},
        {kanji: '高', meaning: 'cao', reading: 'たか'},
        {kanji: '短', meaning: 'ngắn', reading: 'みじか'},
        {kanji: '長', meaning: 'dài', reading: 'なが'}
    ],
    9: [
        {kanji: '好', meaning: 'thích', reading: 'す'},
        {kanji: '歌', meaning: 'bài hát', reading: 'うた'},
        {kanji: '音', meaning: 'âm thanh', reading: 'おと'},
        {kanji: '楽', meaning: 'vui, nhạc', reading: 'たの・らく'},
        {kanji: '車', meaning: 'xe', reading: 'くるま'},
        {kanji: '映', meaning: 'chiếu', reading: 'うつ'},
        {kanji: '画', meaning: 'tranh, phim', reading: 'が'},
        {kanji: '旅', meaning: 'du lịch', reading: 'たび'},
        {kanji: '海', meaning: 'biển', reading: 'うみ'},
        {kanji: '外', meaning: 'ngoài', reading: 'そと'}
    ],
    10: [
        {kanji: '駅', meaning: 'ga tàu', reading: 'えき'},
        {kanji: '上', meaning: 'trên', reading: 'うえ'},
        {kanji: '下', meaning: 'dưới', reading: 'した'},
        {kanji: '地', meaning: 'đất', reading: 'ち'},
        {kanji: '図', meaning: 'bản đồ', reading: 'ず'},
        {kanji: '館', meaning: 'quán', reading: 'かん'},
        {kanji: '右', meaning: 'phải', reading: 'みぎ'},
        {kanji: '左', meaning: 'trái', reading: 'ひだり'},
        {kanji: '道', meaning: 'đường', reading: 'みち'},
        {kanji: '起', meaning: 'dậy', reading: 'お'},
        {kanji: '歩', meaning: 'đi bộ', reading: 'ある'},
        {kanji: '乗', meaning: 'lên (xe)', reading: 'の'}
    ],
    11: [
        {kanji: '始', meaning: 'bắt đầu', reading: 'はじ'},
        {kanji: '終', meaning: 'kết thúc', reading: 'お'},
        {kanji: '勉', meaning: 'cố gắng', reading: 'べん'},
        {kanji: '強', meaning: 'mạnh, học', reading: 'つよ・きょう'},
        {kanji: '朝', meaning: 'buổi sáng', reading: 'あさ'},
        {kanji: '昼', meaning: 'buổi trưa', reading: 'ひる'},
        {kanji: '夜', meaning: 'buổi tối', reading: 'よる'}
    ]
};

let currentTest = {
    lesson: 8,
    questions: [],
    currentIndex: 0,
    score: 0,
    answers: []
};

function loadKanjiTest() {
    const lesson = document.getElementById('lessonSelect').value;
    currentTest.lesson = lesson;
}

function startKanjiTest() {
    const lesson = currentTest.lesson;
    const allKanji = KANJI_DATA[lesson];
    
    // Random 5 kanji
    const shuffled = [...allKanji].sort(() => 0.5 - Math.random());
    currentTest.questions = shuffled.slice(0, 5);
    currentTest.currentIndex = 0;
    currentTest.score = 0;
    currentTest.answers = [];
    
    // Show test area
    document.getElementById('testArea').style.display = 'block';
    document.getElementById('resultArea').style.display = 'none';
    
    showQuestion();
}

function showQuestion() {
    const question = currentTest.questions[currentTest.currentIndex];
    const questionNum = currentTest.currentIndex + 1;
    
    document.getElementById('questionTitle').textContent = `Câu ${questionNum}/5`;
    document.getElementById('kanjiDisplay').textContent = question.kanji;
    
    // Generate options (1 correct + 3 wrong) - using reading instead of meaning
    const allKanji = KANJI_DATA[currentTest.lesson];
    const wrongOptions = allKanji
        .filter(k => k.kanji !== question.kanji)
        .sort(() => 0.5 - Math.random())
        .slice(0, 3);
    
    const options = [question, ...wrongOptions].sort(() => 0.5 - Math.random());
    
    const optionsArea = document.getElementById('optionsArea');
    optionsArea.innerHTML = '';
    
    options.forEach((opt, index) => {
        const button = document.createElement('button');
        button.className = 'option-button';
        const span = document.createElement('span');
        span.textContent = opt.reading; // Show furigana instead of meaning
        button.appendChild(span);
        button.onclick = () => selectAnswer(opt.kanji === question.kanji, button);
        optionsArea.appendChild(button);
    });
}

function selectAnswer(isCorrect, button) {
    // Disable all buttons
    const buttons = document.querySelectorAll('.option-button');
    buttons.forEach(btn => btn.disabled = true);
    
    // Mark correct/wrong
    if (isCorrect) {
        button.classList.add('correct');
        currentTest.score++;
    } else {
        button.classList.add('wrong');
        // Highlight correct answer
        const question = currentTest.questions[currentTest.currentIndex];
        buttons.forEach(btn => {
            if (btn.textContent === question.reading) {
                btn.classList.add('correct');
            }
        });
    }
    
    // Save answer
    currentTest.answers.push({
        kanji: currentTest.questions[currentTest.currentIndex].kanji,
        reading: currentTest.questions[currentTest.currentIndex].reading,
        correct: isCorrect
    });
    
    // Next question after delay
    setTimeout(() => {
        currentTest.currentIndex++;
        if (currentTest.currentIndex < 5) {
            showQuestion();
        } else {
            showResult();
        }
    }, 1500);
}

function showResult() {
    document.getElementById('testArea').style.display = 'none';
    document.getElementById('resultArea').style.display = 'block';
    
    const scoreTitle = document.getElementById('scoreTitle');
    const resultDetails = document.getElementById('resultDetails');
    
    scoreTitle.textContent = `${currentTest.score}/5`;
    
    let html = '';
    currentTest.answers.forEach((ans, i) => {
        html += `<div class="result-item ${ans.correct ? 'correct' : 'wrong'}">
            <div class="result-kanji">${ans.kanji}</div>
            <div class="result-answer correct-answer">✓ ${ans.reading}</div>
        </div>`;
    });
    
    resultDetails.innerHTML = html;
}

// ===== READING QUIZ FUNCTIONS =====
let quizData = [];
let currentQuizIndex = 0;
let quizScore = 0;
let selectedAnswer = null;
let userAnswers = [];

// 42 câu hỏi kiểu thi FE - đa dạng dạng câu hỏi
const readingQuizData = [
    // PHẦN 1: NGỮ PHÁP - Bài 8 (10 câu)
    {
        type: "grammar",
        question: "わたしは ホーチミン＿＿ すんでいます。",
        options: ["に", "で", "を", "へ"],
        correct: 0,
        explanation: "Dùng に với すんでいます để chỉ nơi sinh sống"
    },
    {
        type: "grammar",
        question: "かぞくは 4にん＿＿ すんでいます。",
        options: ["に", "で", "が", "を"],
        correct: 1,
        explanation: "Dùng で để chỉ số người sống cùng"
    },
    {
        type: "grammar",
        question: "いぬ＿＿ 1ぴき います。",
        options: ["は", "を", "が", "に"],
        correct: 2,
        explanation: "Dùng が với います khi nói về sự tồn tại"
    },
    {
        type: "grammar",
        question: "かみが ながい＿＿、きれいです。",
        options: ["て", "くて", "で", "に"],
        correct: 1,
        explanation: "Tính từ い nối bằng くて"
    },
    {
        type: "grammar",
        question: "しんせつ＿＿、やさしいです。",
        options: ["くて", "て", "で", "に"],
        correct: 2,
        explanation: "Tính từ な nối bằng で"
    },
    {
        type: "grammar",
        question: "ちちは わたし＿＿ ほんを くれました。",
        options: ["を", "に", "が", "で"],
        correct: 1,
        explanation: "Dùng に để chỉ người nhận trong câu くれる"
    },
    {
        type: "grammar",
        question: "わたしは ともだち＿＿ プレゼントを もらいました。",
        options: ["を", "が", "に", "で"],
        correct: 2,
        explanation: "Dùng に để chỉ người cho trong câu もらう"
    },
    {
        type: "vocabulary",
        question: "「背が高い」の意味は？",
        options: ["Cao", "Thấp", "Dài", "Ngắn"],
        correct: 0,
        explanation: "せが たかい = cao (về chiều cao)"
    },
    {
        type: "vocabulary",
        question: "「家族」を読んでください。",
        options: ["かぞく", "いえぞく", "かそく", "けぞく"],
        correct: 0,
        explanation: "家族 đọc là かぞく (gia đình)"
    },
    {
        type: "grammar",
        question: "A: どんな ひとですか。B: やさしい＿＿ です。",
        options: ["の", "な", "ひと", "もの"],
        correct: 2,
        explanation: "Trả lời bằng やさしい ひと です"
    },

    // PHẦN 2: NGỮ PHÁP - Bài 9 (11 câu)
    {
        type: "grammar",
        question: "わたしの しゅみは おんがくを きく＿＿ です。",
        options: ["の", "こと", "もの", "ひと"],
        correct: 1,
        explanation: "Dùng こと để danh từ hóa động từ khi nói về sở thích"
    },
    {
        type: "grammar",
        question: "1しゅうかん＿＿ 2かい テニスを します。",
        options: ["で", "を", "に", "が"],
        correct: 2,
        explanation: "Dùng に với tần suất: 1しゅうかんに 2かい"
    },
    {
        type: "vocabulary",
        question: "「映画を見る」を読んでください。",
        options: ["えいがを みる", "えがを みる", "えいかを みる", "がえいを みる"],
        correct: 0,
        explanation: "映画 đọc là えいが (phim)"
    },
    {
        type: "grammar",
        question: "えいがを み＿＿、ごはんを たべました。",
        options: ["る", "た", "て", "に"],
        correct: 2,
        explanation: "Dùng て để nối các hành động theo thứ tự"
    },
    {
        type: "vocabulary",
        question: "「旅行」の意味は？",
        options: ["Du lịch", "Biển", "Xe", "Nhạc"],
        correct: 0,
        explanation: "りょこう = du lịch"
    },
    {
        type: "grammar",
        question: "A: どうやって がっこうへ いきますか。B: バス＿＿ いきます。",
        options: ["を", "に", "で", "が"],
        correct: 2,
        explanation: "Dùng で để chỉ phương tiện"
    },
    {
        type: "vocabulary",
        question: "「好き」を読んでください。",
        options: ["すき", "こうき", "よしき", "こき"],
        correct: 0,
        explanation: "好き đọc là すき (thích)"
    },
    {
        type: "grammar",
        question: "りょうり＿＿ できます。",
        options: ["を", "に", "が", "で"],
        correct: 2,
        explanation: "Dùng が với できます"
    },
    {
        type: "reading",
        passage: "わたしは まいにち 6じに おきます。あさごはんを たべて、がっこうへ いきます。",
        question: "なんじに おきますか。",
        options: ["5じ", "6じ", "7じ", "8じ"],
        correct: 1,
        explanation: "6じに おきます = dậy lúc 6 giờ"
    },
    {
        type: "vocabulary",
        question: "「音楽」を読んでください。",
        options: ["おとがく", "おんがく", "ねがく", "いんがく"],
        correct: 1,
        explanation: "音楽 đọc là おんがく (âm nhạc)"
    },
    {
        type: "grammar",
        question: "A: しゅうまつ なにを しますか。B: ほんを よん＿＿、えいがを みたり します。",
        options: ["で", "だり", "たり", "て"],
        correct: 2,
        explanation: "Dùng たり để liệt kê hành động không theo thứ tự"
    },

    // PHẦN 3: NGỮ PHÁP - Bài 10 (10 câu)
    {
        type: "grammar",
        question: "A: もう しゅくだいを しましたか。B: いいえ、まだ＿＿。",
        options: ["しました", "します", "していません", "しません"],
        correct: 2,
        explanation: "まだ + thể phủ định tiếp diễn = vẫn chưa"
    },
    {
        type: "grammar",
        question: "コンビニへ いって＿＿。",
        options: ["ください", "きます", "いきます", "あります"],
        correct: 1,
        explanation: "Vてきます = đi làm gì rồi quay lại"
    },
    {
        type: "grammar",
        question: "まどから やま＿＿ みえます。",
        options: ["を", "に", "が", "で"],
        correct: 2,
        explanation: "Dùng が với みえます (nhìn thấy)"
    },
    {
        type: "grammar",
        question: "しゃしんを とっ＿＿ いいですか。",
        options: ["て", "ても", "たら", "ば"],
        correct: 1,
        explanation: "Vてもいいですか = xin phép làm gì"
    },
    {
        type: "grammar",
        question: "ここで たばこを すわ＿＿ ください。",
        options: ["って", "ないで", "なくて", "ない"],
        correct: 1,
        explanation: "Vないでください = xin đừng làm gì"
    },
    {
        type: "vocabulary",
        question: "「駅」を読んでください。",
        options: ["えき", "いき", "えい", "うえき"],
        correct: 0,
        explanation: "駅 đọc là えき (ga)"
    },
    {
        type: "grammar",
        question: "こうえんを＿＿ います。",
        options: ["あるいて", "あるき", "あるく", "あるけ"],
        correct: 0,
        explanation: "を + động từ di chuyển (あるいて います = đang đi bộ qua)"
    },
    {
        type: "reading",
        passage: "カフェから うみが みえます。とても きれいです。",
        question: "なにが みえますか。",
        options: ["やま", "うみ", "そら", "かわ"],
        correct: 1,
        explanation: "うみが みえます = nhìn thấy biển"
    },
    {
        type: "vocabulary",
        question: "「道」を読んでください。",
        options: ["どう", "みち", "どお", "とう"],
        correct: 1,
        explanation: "道 đọc là みち (đường)"
    },
    {
        type: "grammar",
        question: "ここで およぐ＿＿が できます。",
        options: ["の", "こと", "もの", "ひと"],
        correct: 1,
        explanation: "Vることができます = có thể làm gì"
    },

    // PHẦN 4: NGỮ PHÁP - Bài 11 (11 câu)
    {
        type: "grammar",
        question: "わたしは さかなは すきです＿＿、にくは すきじゃありません。",
        options: ["そして", "でも", "が", "から"],
        correct: 2,
        explanation: "Dùng が để nối câu đối lập"
    },
    {
        type: "grammar",
        question: "まいにち にほんごを べんきょうし＿＿ います。",
        options: ["て", "た", "に", "で"],
        correct: 0,
        explanation: "Vています = đang làm gì (thói quen, tiếp diễn)"
    },
    {
        type: "grammar",
        question: "やすみの ひは ほんを よん＿＿、おんがくを きいたり します。",
        options: ["で", "だり", "たり", "て"],
        correct: 2,
        explanation: "Vたり Vたり します = làm việc này việc kia"
    },
    {
        type: "grammar",
        question: "ひま＿＿ とき、なにを しますか。",
        options: ["の", "な", "だ", "で"],
        correct: 1,
        explanation: "Tính từ な + な + とき"
    },
    {
        type: "grammar",
        question: "さむい とき、あたたかい おちゃ＿＿ のみます。",
        options: ["が", "を", "に", "で"],
        correct: 1,
        explanation: "Dùng を cho tân ngữ với のみます"
    },
    {
        type: "vocabulary",
        question: "「起きる」を読んでください。",
        options: ["おこる", "おきる", "おちる", "あきる"],
        correct: 1,
        explanation: "起きる đọc là おきる (thức dậy)"
    },
    {
        type: "reading",
        passage: "あした テストが あります。だから きょうは べんきょうします。",
        question: "いつ テストが ありますか。",
        options: ["きょう", "あした", "きのう", "あさって"],
        correct: 1,
        explanation: "あした テストが あります = ngày mai có kiểm tra"
    },
    {
        type: "grammar",
        question: "A: どうしましたか。B: あたま＿＿ いたいです。",
        options: ["を", "に", "が", "で"],
        correct: 2,
        explanation: "Dùng が với tính từ (あたまが いたい)"
    },
    {
        type: "vocabulary",
        question: "「朝」を読んでください。",
        options: ["よる", "ひる", "あさ", "ゆう"],
        correct: 2,
        explanation: "朝 đọc là あさ (buổi sáng)"
    },
    {
        type: "grammar",
        question: "にほんごが じょうず＿＿ なりました。",
        options: ["を", "が", "に", "で"],
        correct: 2,
        explanation: "になります = trở nên (dùng với tính từ な, danh từ)"
    },
    {
        type: "reading",
        passage: "わたしは 7じに おきます。あには 6じに おきます。ちちは 5じに おきます。",
        question: "だれが いちばん はやく おきますか。",
        options: ["わたし", "あに", "ちち", "はは"],
        correct: 2,
        explanation: "ちちは 5じに おきます = bố dậy lúc 5 giờ (sớm nhất)"
    }
];

function startReadingQuiz() {
    quizData = [...readingQuizData];
    currentQuizIndex = 0;
    quizScore = 0;
    selectedAnswer = null;
    userAnswers = [];
    
    document.querySelector('.grammar-item').style.display = 'none';
    document.getElementById('quizArea').style.display = 'block';
    document.getElementById('quizResult').style.display = 'none';
    
    showQuizQuestion();
}

function showQuizQuestion() {
    const question = quizData[currentQuizIndex];
    
    document.getElementById('currentQuestion').textContent = `Câu ${currentQuizIndex + 1}/42`;
    document.getElementById('quizScore').textContent = `Điểm: ${quizScore}`;
    document.getElementById('progressFill').style.width = `${((currentQuizIndex) / 42) * 100}%`;
    
    // Hiển thị đoạn văn (nếu có) hoặc ẩn đi
    const passageEl = document.querySelector('.reading-passage');
    if (question.passage) {
        passageEl.style.display = 'block';
        document.getElementById('passageText').textContent = question.passage;
    } else {
        passageEl.style.display = 'none';
    }
    
    document.getElementById('questionText').textContent = question.question;
    
    const optionsHtml = question.options.map((option, index) => `
        <button class="quiz-option" onclick="selectQuizAnswer(${index})">
            ${String.fromCharCode(65 + index)}. ${option}
        </button>
    `).join('');
    
    document.getElementById('quizOptions').innerHTML = optionsHtml;
    document.getElementById('answerFeedback').style.display = 'none';
    document.getElementById('submitAnswer').style.display = 'inline-block';
    document.getElementById('nextQuestion').style.display = 'none';
    
    selectedAnswer = null;
}

function selectQuizAnswer(index) {
    if (selectedAnswer !== null) return;
    
    const options = document.querySelectorAll('.quiz-option');
    options.forEach(opt => opt.classList.remove('selected'));
    options[index].classList.add('selected');
    selectedAnswer = index;
}

function submitQuizAnswer() {
    if (selectedAnswer === null) {
        alert('Vui lòng chọn một đáp án!');
        return;
    }
    
    const question = quizData[currentQuizIndex];
    const options = document.querySelectorAll('.quiz-option');
    const feedback = document.getElementById('answerFeedback');
    
    // Lưu câu trả lời
    userAnswers[currentQuizIndex] = selectedAnswer;
    
    // Kiểm tra đáp án
    if (selectedAnswer === question.correct) {
        quizScore++;
        feedback.innerHTML = `<span class="correct">✓ Đúng rồi!</span><p>${question.explanation}</p>`;
        options[selectedAnswer].classList.add('correct');
    } else {
        feedback.innerHTML = `<span class="incorrect">✗ Sai rồi!</span><p>Đáp án đúng: ${String.fromCharCode(65 + question.correct)}. ${question.options[question.correct]}</p><p>${question.explanation}</p>`;
        options[selectedAnswer].classList.add('incorrect');
        options[question.correct].classList.add('correct');
    }
    
    feedback.style.display = 'block';
    document.getElementById('submitAnswer').style.display = 'none';
    document.getElementById('nextQuestion').style.display = 'inline-block';
    document.getElementById('quizScore').textContent = `Điểm: ${quizScore}`;
}

function nextQuizQuestion() {
    currentQuizIndex++;
    
    if (currentQuizIndex < quizData.length) {
        showQuizQuestion();
    } else {
        showQuizResult();
    }
}

function showQuizResult() {
    document.getElementById('quizArea').style.display = 'none';
    document.getElementById('quizResult').style.display = 'block';
    
    const percentage = ((quizScore / 42) * 100).toFixed(1);
    document.getElementById('finalScore').textContent = `${quizScore}/42 (${percentage}%)`;
    
    let grade = '';
    if (percentage >= 90) grade = 'Xuất sắc! 🏆';
    else if (percentage >= 80) grade = 'Giỏi! 🌟';
    else if (percentage >= 70) grade = 'Khá tốt! 👍';
    else if (percentage >= 60) grade = 'Trung bình 📚';
    else grade = 'Cần cố gắng thêm! 💪';
    
    document.getElementById('gradeText').textContent = grade;
}

function restartQuiz() {
    startReadingQuiz();
}

function backToQuizPanel() {
    document.getElementById('quizResult').style.display = 'none';
    document.querySelector('.grammar-item').style.display = 'block';
}
        options: ["ほん", "ケーキ", "かばん", "プレゼント"],
        correct: 2,
        explanation: "Bố tặng cái cặp (ちちは かばんを くれました)"
    },
    {
        passage: `きのうは たんじょうびでした。ちちは わたしに あたらしい かばんを くれました。ははは ケーキを つくって くれました。あには わたしに ほんを あげました。いもうとも プレゼントを くれました。とても たのしい いちにちでした。`,
        question: "だれが ケーキを つくりましたか。",
        options: ["ちち", "はは", "あに", "いもうと"],
        correct: 1,
        explanation: "Mẹ làm bánh (ははは ケーキを つくって くれました)"
    },
    {
        passage: `やまださんは わたしの せんぱいです。だいがくで べんきょうして います。やまださんは しんせつで、あたまが いいです。まいにち としょかんで べんきょうして います。やまださんは らいねん にほんへ りゅうがくします。`,
        question: "やまださんは どこで べんきょうして いますか。",
        options: ["がっこう", "うち", "としょかん", "こうえん"],
        correct: 2,
        explanation: "Yamada học ở thư viện (としょかんで べんきょうして います)"
    },
    {
        passage: `やまださんは わたしの せんぱいです。だいがくで べんきょうして います。やまださんは しんせつで、あたまが いいです。まいにち としょかんで べんきょうして います。やまださんは らいねん にほんへ りゅうがくします。`,
        question: "やまださんは いつ にほんへ いきますか。",
        options: ["きょう", "あした", "らいしゅう", "らいねん"],
        correct: 3,
        explanation: "Yamada sang Nhật năm sau (らいねん にほんへ りゅうがくします)"
    },
    {
        passage: `わたしの いもうとは こうこうせいです。いもうとは かわいくて、げんきです。いもうとは うたを うたうことが すきです。まいにち カラオケで れんしゅうして います。いもうとの ゆめは かしゅに なることです。`,
        question: "いもうとは なにが すきですか。",
        options: ["ダンス", "うた", "スポーツ", "えいが"],
        correct: 1,
        explanation: "Em gái thích hát (うたを うたうことが すきです)"
    },
    {
        passage: `わたしの いもうとは こうこうせいです。いもうとは かわいくて、げんきです。いもうとは うたを うたうことが すきです。まいにち カラオケで れんしゅうして います。いもうとの ゆめは かしゅに なることです。`,
        question: "いもうとの ゆめは なんですか。",
        options: ["せんせい", "いしゃ", "かしゅ", "かいしゃいん"],
        correct: 2,
        explanation: "Ước mơ của em gái là trở thành ca sĩ (かしゅに なること)"
    },

    // Bài 9 - 11 câu
    {
        passage: `わたしの しゅみは おんがくを きくことです。まいにち 1じかん ぐらい きいて います。ポップスが すきです。ときどき コンサートへ いきます。おんがくを きくと、げんきに なります。ともだちと カラオケへ いくことも すきです。`,
        question: "しゅみは なんですか。",
        options: ["スポーツ", "りょうり", "おんがく", "どくしょ"],
        correct: 2,
        explanation: "Sở thích là nghe nhạc (しゅみは おんがくを きくことです)"
    },
    {
        passage: `わたしの しゅみは おんがくを きくことです。まいにち 1じかん ぐらい きいて います。ポップスが すきです。ときどき コンサートへ いきます。おんがくを きくと、げんきに なります。ともだちと カラオケへ いくことも すきです。`,
        question: "まいにち どのぐらい おんがくを ききますか。",
        options: ["30ぷん", "1じかん", "2じかん", "3じかん"],
        correct: 1,
        explanation: "Nghe khoảng 1 tiếng mỗi ngày (まいにち 1じかん ぐらい)"
    },
    {
        passage: `しゅうまつは ともだちと えいがを みました。えいがかんへ いって、アクションえいがを みました。とても おもしろかったです。それから、レストランで ばんごはんを たべました。ともだちと たくさん はなしました。たのしい しゅうまつでした。`,
        question: "なにを みましたか。",
        options: ["テレビ", "えいが", "ほん", "しんぶん"],
        correct: 1,
        explanation: "Xem phim (えいがを みました)"
    },
    {
        passage: `しゅうまつは ともだちと えいがを みました。えいがかんへ いって、アクションえいがを みました。とても おもしろかったです。それから、レストランで ばんごはんを たべました。ともだちと たくさん はなしました。たのしい しゅうまつでした。`,
        question: "だれと えいがを みましたか。",
        options: ["ひとりで", "かぞくと", "ともだちと", "せんせいと"],
        correct: 2,
        explanation: "Xem với bạn bè (ともだちと えいがを みました)"
    },
    {
        passage: `けさ 6じに おきました。シャワーを あびて、あさごはんを たべました。それから、バスで がっこうへ いきました。がっこうで にほんごを べんきょうしました。ごご、としょかんで しゅくだいを しました。よる、うちで テレビを みました。`,
        question: "なんじに おきましたか。",
        options: ["5じ", "6じ", "7じ", "8じ"],
        correct: 1,
        explanation: "Dậy lúc 6 giờ (6じに おきました)"
    },
    {
        passage: `けさ 6じに おきました。シャワーを あびて、あさごはんを たべました。それから、バスで がっこうへ いきました。がっこうで にほんごを べんきょうしました。ごご、としょかんで しゅくだいを しました。よる、うちで テレビを みました。`,
        question: "どうやって がっこうへ いきましたか。",
        options: ["あるいて", "バスで", "でんしゃで", "じてんしゃで"],
        correct: 1,
        explanation: "Đi bằng xe buýt (バスで がっこうへ いきました)"
    },
    {
        passage: `わたしは りょうりが できます。まいにち じぶんで りょうりを つくります。ベトナムりょうりが とくいです。ときどき ともだちに りょうりを つくって あげます。ともだちは「おいしい」と いいます。うれしいです。`,
        question: "なにが できますか。",
        options: ["うた", "ダンス", "りょうり", "スポーツ"],
        correct: 2,
        explanation: "Có thể nấu ăn (りょうりが できます)"
    },
    {
        passage: `わたしは りょうりが できます。まいにち じぶんで りょうりを つくります。ベトナムりょうりが とくいです。ときどき ともだちに りょうりを つくって あげます。ともだちは「おいしい」と いいます。うれしいです。`,
        question: "どんな りょうりが とくいですか。",
        options: ["にほんりょうり", "ベトナムりょうり", "かんこくりょうり", "ちゅうかりょうり"],
        correct: 1,
        explanation: "Giỏi món Việt (ベトナムりょうりが とくいです)"
    },
    {
        passage: `にちようびに うみへ いきました。ともだちと およぎました。すなはまで あそびました。きれいな かいがらを ひろいました。それから、うみの ちかくの レストランで さかなを たべました。とても おいしかったです。たのしかったです。`,
        question: "どこへ いきましたか。",
        options: ["やま", "うみ", "こうえん", "かわ"],
        correct: 1,
        explanation: "Đi biển (うみへ いきました)"
    },
    {
        passage: `にちようびに うみへ いきました。ともだちと およぎました。すなはまで あそびました。きれいな かいがらを ひろいました。それから、うみの ちかくの レストランで さかなを たべました。とても おいしかったです。たのしかったです。`,
        question: "レストランで なにを たべましたか。",
        options: ["にく", "さかな", "やさい", "くだもの"],
        correct: 1,
        explanation: "Ăn cá (さかなを たべました)"
    },
    {
        passage: `わたしは よく ほんを よみます。1しゅうかんに 2かい ぐらい としょかんへ いきます。すいようびと どようびに いきます。としょかんは しずかで、べんきょうしやすいです。しょうせつや まんがを よみます。ほんを よむことが だいすきです。`,
        question: "1しゅうかんに なんかい としょかんへ いきますか。",
        options: ["1かい", "2かい", "3かい", "まいにち"],
        correct: 1,
        explanation: "Đi thư viện 2 lần một tuần (1しゅうかんに 2かい ぐらい)"
    },
    {
        passage: `わたしは よく ほんを よみます。1しゅうかんに 2かい ぐらい としょかんへ いきます。すいようびと どようびに いきます。としょかんは しずかで、べんきょうしやすいです。しょうせつや まんがを よみます。ほんを よむことが だいすきです。`,
        question: "どんな ほんを よみますか。",
        options: ["ざっしだけ", "しんぶんだけ", "しょうせつや まんが", "きょうかしょだけ"],
        correct: 2,
        explanation: "Đọc tiểu thuyết và manga (しょうせつや まんがを よみます)"
    },

    // Bài 10 - 10 câu
    {
        passage: `えきの ちかくに あたらしい カフェが できました。きれいで、おおきい カフェです。まだ いって いません。こんど ともだちと いきたいです。カフェから やまが みえます。コーヒーが おいしいそうです。`,
        question: "カフェは どこに ありますか。",
        options: ["がっこうの ちかく", "えきの ちかく", "うちの ちかく", "こうえんの ちかく"],
        correct: 1,
        explanation: "Quán cà phê ở gần ga (えきの ちかくに)"
    },
    {
        passage: `えきの ちかくに あたらしい カフェが できました。きれいで、おおきい カフェです。まだ いって いません。こんど ともだちと いきたいです。カフェから やまが みえます。コーヒーが おいしいそうです。`,
        question: "もう カフェへ いきましたか。",
        options: ["はい、いきました", "いいえ、まだです", "よく いきます", "きのう いきました"],
        correct: 1,
        explanation: "Chưa đi (まだ いって いません)"
    },
    {
        passage: `あした テストが あります。だから、きょうは いえで べんきょうします。としょかんへ いかないで、うちで べんきょうします。テレビを みないで、べんきょうします。ともだちと あそばないで、べんきょうします。がんばります。`,
        question: "あした なにが ありますか。",
        options: ["しけん", "テスト", "パーティー", "りょこう"],
        correct: 1,
        explanation: "Ngày mai có bài kiểm tra (あした テストが あります)"
    },
    {
        passage: `あした テストが あります。だから、きょうは いえで べんきょうします。としょかんへ いかないで、うちで べんきょうします。テレビを みないで、べんきょうします。ともだちと あそばないで、べんきょうします。がんばります。`,
        question: "きょう どこで べんきょうしますか。",
        options: ["としょかん", "がっこう", "いえ", "カフェ"],
        correct: 2,
        explanation: "Học ở nhà (いえで べんきょうします)"
    },
    {
        passage: `コンビニへ いって きます。ジュースと おかしを かって きます。10ぷん ぐらいで かえって きます。でんわが あったら、メッセージを おいて ください。`,
        question: "どこへ いきますか。",
        options: ["スーパー", "コンビニ", "デパート", "ほんや"],
        correct: 1,
        explanation: "Đi cửa hàng tiện lợi (コンビニへ いって きます)"
    },
    {
        passage: `コンビニへ いって きます。ジュースと おかしを かって きます。10ぷん ぐらいで かえって きます。でんわが あったら、メッセージを おいて ください。`,
        question: "なにを かいますか。",
        options: ["ほんと ざっし", "ジュースと おかし", "くつと かばん", "さかなと やさい"],
        correct: 1,
        explanation: "Mua nước ngọt và kẹo (ジュースと おかしを かって きます)"
    },
    {
        passage: `びじゅつかんで えを みて います。ゆうめいな がかの えです。とても きれいです。しゃしんを とっても いいですか。いいえ、とらないで ください。びじゅつかんの なかで しゃしんを とることが できません。`,
        question: "どこに いますか。",
        options: ["としょかん", "びじゅつかん", "こうえん", "がっこう"],
        correct: 1,
        explanation: "Đang ở viện bảo tàng mỹ thuật (びじゅつかんで)"
    },
    {
        passage: `びじゅつかんで えを みて います。ゆうめいな がかの えです。とても きれいです。しゃしんを とっても いいですか。いいえ、とらないで ください。びじゅつかんの なかで しゃしんを とることが できません。`,
        question: "びじゅつかんで しゃしんを とることが できますか。",
        options: ["はい、できます", "いいえ、できません", "ときどき できます", "わかりません"],
        correct: 1,
        explanation: "Không thể chụp ảnh (とることが できません)"
    },
    {
        passage: `にほんごの クラスは 9じに はじまります。まえに コーヒーを のんで、しんぶんを よみます。8じに きょうしつに つきます。ともだちと はなして、じゅぎょうの じゅんびを します。せんせいが きて、じゅぎょうが はじまります。`,
        question: "なんじに クラスが はじまりますか。",
        options: ["8じ", "9じ", "10じ", "11じ"],
        correct: 1,
        explanation: "Lớp bắt đầu lúc 9 giờ (9じに はじまります)"
    },
    {
        passage: `にほんごの クラスは 9じに はじまります。まえに コーヒーを のんで、しんぶんを よみます。8じに きょうしつに つきます。ともだちと はなして、じゅぎょうの じゅんびを します。せんせいが きて、じゅぎょうが はじまります。`,
        question: "クラスの まえに なにを しますか。",
        options: ["ねます", "べんきょうします", "コーヒーを のみます", "りょうりを つくります"],
        correct: 2,
        explanation: "Uống cà phê trước lớp (コーヒーを のんで)"
    },

    // Bài 11 - 10 câu
    {
        passage: `わたしは にほんごが すきです。でも、かんじは むずかしいです。まいにち かんじを べんきょうして います。ノートに なんども かきます。かんじの テストは むずかしいですが、がんばります。せんせいは やさしいです。`,
        question: "なにが むずかしいですか。",
        options: ["ぶんぽう", "たんご", "かんじ", "かいわ"],
        correct: 2,
        explanation: "Kanji khó (かんじは むずかしいです)"
    },
    {
        passage: `わたしは にほんごが すきです。でも、かんじは むずかしいです。まいにち かんじを べんきょうして います。ノートに なんども かきます。かんじの テストは むずかしいですが、がんばります。せんせいは やさしいです。`,
        question: "どうやって かんじを べんきょうしますか。",
        options: ["よむだけ", "きくだけ", "ノートに かきます", "なにも しません"],
        correct: 2,
        explanation: "Viết vào vở (ノートに なんども かきます)"
    },
    {
        passage: `やすみの ひは いろいろな ことを します。あさ おきて、ジョギングを したり、ヨガを したり します。ひるごはんの あとで、ほんを よんだり、おんがくを きいたり します。よる、ともだちと でんわで はなします。`,
        question: "あさ なにを しますか。",
        options: ["ねます", "べんきょうします", "ジョギングや ヨガを します", "りょうりを つくります"],
        correct: 2,
        explanation: "Chạy bộ và yoga (ジョギングを したり、ヨガを したり します)"
    },
    {
        passage: `やすみの ひは いろいろな ことを します。あさ おきて、ジョギングを したり、ヨガを したり します。ひるごはんの あとで、ほんを よんだり、おんがくを きいたり します。よる、ともだちと でんわで はなします。`,
        question: "ひるごはんの あとで なにを しますか。",
        options: ["ねます", "ほんを よんだり おんがくを きいたり します", "さんぽします", "テレビを みます"],
        correct: 1,
        explanation: "Đọc sách và nghe nhạc (ほんを よんだり、おんがくを きいたり します)"
    },
    {
        passage: `さむい とき、あたたかい おちゃを のみます。あつい とき、つめたい ジュースを のみます。つかれた とき、おんがくを ききます。ひまな とき、さんぽします。いそがしい ときも、うんどうします。`,
        question: "さむい とき、なにを のみますか。",
        options: ["つめたい ジュース", "あたたかい おちゃ", "ビール", "みず"],
        correct: 1,
        explanation: "Uống trà ấm (あたたかい おちゃを のみます)"
    },
    {
        passage: `さむい とき、あたたかい おちゃを のみます。あつい とき、つめたい ジュースを のみます。つかれた とき、おんがくを ききます。ひまな とき、さんぽします。いそがしい ときも、うんどうします。`,
        question: "つかれた とき、なにを しますか。",
        options: ["ねます", "おんがくを ききます", "べんきょうします", "りょうりします"],
        correct: 1,
        explanation: "Nghe nhạc (おんがくを ききます)"
    },
    {
        passage: `らいしゅう テストが あります。どうしますか。まず、きょうかしょを よみます。それから、もんだいしゅうを します。わからない ことが あったら、せんせいに ききます。テストの まえの ひは、はやく ねます。`,
        question: "テストは いつ ありますか。",
        options: ["きょう", "あした", "らいしゅう", "らいげつ"],
        correct: 2,
        explanation: "Tuần sau có kiểm tra (らいしゅう テストが あります)"
    },
    {
        passage: `らいしゅう テストが あります。どうしますか。まず、きょうかしょを よみます。それから、もんだいしゅうを します。わからない ことが あったら、せんせいに ききます。テストの まえの ひは、はやく ねます。`,
        question: "わからない とき、どうしますか。",
        options: ["なにも しません", "ともだちに ききます", "せんせいに ききます", "あきらめます"],
        correct: 2,
        explanation: "Hỏi giáo viên (せんせいに ききます)"
    },
    {
        passage: `わたしは まいあさ 6じに おきます。あには 7じに おきます。ちちは 5じに おきます。ははは 6じはんに おきます。ちちが いちばん はやく おきます。ちちは まいあさ うんどうします。げんきです。`,
        question: "だれが いちばん はやく おきますか。",
        options: ["わたし", "あに", "ちち", "はは"],
        correct: 2,
        explanation: "Bố dậy sớm nhất (ちちが いちばん はやく おきます)"
    },
    {
        passage: `わたしは まいあさ 6じに おきます。あには 7じに おきます。ちちは 5じに おきます。ははは 6じはんに おきます。ちちが いちばん はやく おきます。ちちは まいあさ うんどうします。げんきです。`,
        question: "ちちは まいあさ なにを しますか。",
        options: ["ねます", "べんきょうします", "うんどうします", "テレビを みます"],
        correct: 2,
        explanation: "Tập thể dục (うんどうします)"
    }
];

function startReadingQuiz() {
    quizData = [...readingQuizData];
    currentQuizIndex = 0;
    quizScore = 0;
    selectedAnswer = null;
    userAnswers = [];
    
    document.querySelector('.grammar-item').style.display = 'none';
    document.getElementById('quizArea').style.display = 'block';
    document.getElementById('quizResult').style.display = 'none';
    
    showQuizQuestion();
}

function showQuizQuestion() {
    const question = quizData[currentQuizIndex];
    
    document.getElementById('currentQuestion').textContent = `Câu ${currentQuizIndex + 1}/42`;
    document.getElementById('quizScore').textContent = `Điểm: ${quizScore}`;
    document.getElementById('progressFill').style.width = `${((currentQuizIndex) / 42) * 100}%`;
    
    document.getElementById('passageText').textContent = question.passage;
    document.getElementById('questionText').textContent = question.question;
    
    const optionsHtml = question.options.map((opt, i) => 
        `<div class="quiz-option" onclick="selectQuizAnswer(${i})">${opt}</div>`
    ).join('');
    
    document.getElementById('quizOptions').innerHTML = optionsHtml;
    document.getElementById('answerFeedback').style.display = 'none';
    document.getElementById('submitAnswer').style.display = 'inline-block';
    document.getElementById('nextQuestion').style.display = 'none';
    
    selectedAnswer = null;
}

function selectQuizAnswer(index) {
    if (selectedAnswer !== null) return;
    
    const options = document.querySelectorAll('.quiz-option');
    options.forEach(opt => opt.classList.remove('selected'));
    options[index].classList.add('selected');
    selectedAnswer = index;
}

function submitQuizAnswer() {
    if (selectedAnswer === null) {
        alert('Vui lòng chọn một đáp án!');
        return;
    }
    
    const question = quizData[currentQuizIndex];
    const options = document.querySelectorAll('.quiz-option');
    const isCorrect = selectedAnswer === question.correct;
    
    if (isCorrect) {
        quizScore++;
        options[selectedAnswer].classList.add('correct');
        document.getElementById('answerFeedback').className = 'answer-feedback correct';
        document.getElementById('answerFeedback').innerHTML = `✓ Đúng rồi!<br>${question.explanation}`;
    } else {
        options[selectedAnswer].classList.add('incorrect');
        options[question.correct].classList.add('correct');
        document.getElementById('answerFeedback').className = 'answer-feedback incorrect';
        document.getElementById('answerFeedback').innerHTML = `✗ Sai rồi!<br>Đáp án đúng: ${question.options[question.correct]}<br>${question.explanation}`;
    }
    
    userAnswers.push({
        question: question.question,
        passage: question.passage,
        userAnswer: question.options[selectedAnswer],
        correctAnswer: question.options[question.correct],
        isCorrect: isCorrect
    });
    
    options.forEach(opt => opt.classList.add('disabled'));
    document.getElementById('answerFeedback').style.display = 'block';
    document.getElementById('submitAnswer').style.display = 'none';
    document.getElementById('nextQuestion').style.display = 'inline-block';
}

function nextQuizQuestion() {
    currentQuizIndex++;
    
    if (currentQuizIndex < quizData.length) {
        showQuizQuestion();
    } else {
        showQuizResult();
    }
}

function showQuizResult() {
    document.getElementById('quizArea').style.display = 'none';
    document.getElementById('quizResult').style.display = 'block';
    
    const percentage = Math.round((quizScore / 42) * 100);
    document.getElementById('finalScore').textContent = `${quizScore}/42`;
    document.getElementById('finalPercentage').textContent = `${percentage}%`;
    
    let detailsHtml = '';
    userAnswers.forEach((ans, i) => {
        detailsHtml += `
            <div class="result-item ${ans.isCorrect ? 'correct' : 'incorrect'}">
                <div class="result-question"><strong>Câu ${i + 1}:</strong> ${ans.question}</div>
                ${!ans.isCorrect ? `<div class="result-answer your-answer">Bạn chọn: ${ans.userAnswer}</div>` : ''}
                <div class="result-answer correct-answer">Đáp án đúng: ${ans.correctAnswer}</div>
            </div>
        `;
    });
    
    document.getElementById('resultDetails').innerHTML = detailsHtml;
}
